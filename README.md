This is a snippet of code I wrote for Freebird.  Taken with permission from SamZ.  
